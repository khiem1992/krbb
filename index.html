<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Báo Cáo Karaoke</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #7c3aed; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .detail-panel { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
    .detail-panel.open { max-height: 3000px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">
  <div class="container mx-auto p-4 max-w-7xl">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Báo Cáo Karaoke</h1>
      <button id="updateBtn" class="bg-purple-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-purple-700 flex items-center">
        <span id="btnText">Cập nhật dữ liệu</span>
      </button>
    </div>

    <!-- Tình trạng hoạt động -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-xl font-bold text-purple-700 mb-2">Tình trạng hoạt động các phòng VIP</h2>
      <p class="text-sm text-gray-600">Dữ liệu cập nhật từ file Excel • <span id="lastUpdate">--:--</span></p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" id="rooms"></div>
    </div>

    <!-- Các phần khác -->
    <div id="content"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4bJdYUsQKDuWoTaCM3PXkvESJw5d2qhmnGepe22kjjPJGQV3K2-bjChISTkSgBi4/exec'; // ← DÁN URL SAU DEPLOY
    const TTL = 24 * 60 * 60 * 1000;
    let isUpdating = false;

    window.onload = () => {
      loadFromLocal() || updateData(false);
      setTimeout(() => updateData(false), 500);
    };

    document.getElementById('updateBtn').onclick = () => {
      if (isUpdating) return;
      updateData(true);
    };

    function loadFromLocal() {
      try {
        const time = localStorage.getItem('lastCacheTime');
        if (!time || Date.now() - parseInt(time) > TTL) {
          clearLocal();
          return null;
        }
        const data = localStorage.getItem('BaoCaoData');
        const hash = localStorage.getItem('lastUpdated');
        if (data && hash) {
          const parsed = JSON.parse(data);
          renderData(parsed);
          showTime(hash);
          return parsed;
        }
      } catch { }
      return null;
    }

    function saveToLocal(data) {
      try {
        localStorage.setItem('BaoCaoData', JSON.stringify(data));
        localStorage.setItem('lastUpdated', data.lastUpdated);
        localStorage.setItem('lastCacheTime', Date.now().toString());
      } catch { }
    }

    function clearLocal() {
      localStorage.removeItem('BaoCaoData');
      localStorage.removeItem('lastUpdated');
      localStorage.removeItem('lastCacheTime');
    }

    function updateData(force = false) {
      if (isUpdating) return;
      isUpdating = true;
      const btn = document.getElementById('updateBtn');
      const text = document.getElementById('btnText');
      btn.classList.add('opacity-70');
      text.innerHTML = '<div class="spinner"></div> Đang tải...';

      const url = force ? `${SCRIPT_URL}?forceRefresh=true` : SCRIPT_URL;
      fetch(url)
        .then(r => r.json())
        .then(server => {
          if (server.status === 'success') {
            const localHash = localStorage.getItem('lastUpdated');
            if (!localHash || server.lastUpdated !== localHash) {
              renderData(server.data);
              saveToLocal(server);
              showTime(server.lastUpdated);
              text.textContent = 'Cập nhật thành công!';
            } else {
              text.textContent = 'Dữ liệu mới nhất';
            }
          }
          setTimeout(() => {
            text.textContent = 'Cập nhật dữ liệu';
            btn.classList.remove('opacity-70');
          }, 1000);
        })
        .catch(() => {
          text.textContent = 'Lỗi kết nối';
        })
        .finally(() => { isUpdating = false; });
    }

    function renderData(data) {
      // === PHÒNG VIP ===
      const roomsHtml = data.trangThaiPhong.rooms.map(r => `
        <div class="bg-white p-5 rounded-xl shadow-md border-l-4 ${r[1]?.includes('Đang') ? 'border-green-500' : 'border-gray-300'}">
          <h3 class="font-bold text-lg">${r[0]}</h3>
          <p class="text-sm">${r[1] || "Trống"}</p>
          <p class="text-xs text-gray-500">${r[2] || ""}</p>
          <p class="text-xs mt-2">${r[3] || ""}</p>
        </div>
      `).join('');
      document.getElementById('rooms').innerHTML = roomsHtml;

      // === CÁC PHẦN KHÁC (TÙY CHỈNH) ===
      // hdHomNay, doanhThu, soNo...
    }

    function showTime(ts) {
      const date = new Date(ts);
      document.getElementById('lastUpdate').textContent = 
        date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
  </script>
</body>
</html>
