<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Online</title>

    <link rel="preconnect" href="https://script.google.com">
    <link rel="preload" href="https://script.google.com/macros/s/AKfycbxIrxlXbGlg9Y-Y-xYm4BJ9HnqaUL3K2xIps2BZ_WXCzjxShAJyMm5Y3cfMDyxR0d8/exec" as="fetch" crossorigin>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Sử dụng font Inter cho toàn bộ trang */
        body { font-family: 'Inter', sans-serif; }
        
        /* Chuyển động cho Modal */
        #detail-modal { transition: opacity 0.3s ease; }
        #modal-panel { transition: transform 0.3s ease; }
        
        /* Chuyển động cho icon chevron (mũi tên) khi đóng/mở */
        .chevron { transition: transform 0.2s ease-in-out; }
        .chevron-rotated { transform: rotate(180deg); }
        
        /* Chuyển động cho nút Refresh */
        #refresh-button { transition: all 0.3s ease; }
        #refresh-button.disabled { opacity: 0.5; background-color: #555; cursor: not-allowed; transform: scale(0.95); }
        #refresh-icon { transition: transform 0.5s ease; }
        #refresh-button.loading #refresh-icon { transform: rotate(360deg); }
    </style>
</head>
<!-- Tối ưu 1: Đổi sang tông màu 'slate' cho nền và chữ -->
<body class="bg-slate-100 text-slate-800">

    <!-- MODAL -->
    <!-- Tối ưu 1: Đổi màu nền mờ sang tông đậm hơn -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="closeModal()">
        <div id="modal-panel" class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- Tối ưu 1: Đổi màu border và chữ -->
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center rounded-t-xl">
                <h3 id="modal-title" class="text-xl font-semibold text-slate-900">Chi Tiết</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <!-- REFRESH BUTTON -->
    <!-- Tối ưu 3: Đổi sang màu 'indigo' cho cảm giác "công nghệ" hơn -->
    <button id="refresh-button" onclick="forceFetchData()" class="fixed bottom-6 right-6 z-40 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 active:scale-95">
        <!-- ICON ĐÃ THAY ĐỔI: Sử dụng icon "ArrowPath" (mũi tên xoay tròn) đơn giản hơn -->
        <svg id="refresh-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.183m-4.992 0v4.992" />
        </svg>
    </button>
    <!-- Tối ưu 1: Đổi màu toast -->
    <div id="refresh-toast" class="hidden fixed bottom-24 right-6 z-40 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm">
        Đã cập nhật dữ liệu mới!
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <div id="page-loader" class="flex flex-col items-center justify-center min-h-screen">
            <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <!-- Tối ưu 1 & 3: Đổi màu chữ và thêm 'animate-pulse' -->
            <span class="text-lg text-slate-700 mt-4 animate-pulse">Đang tải dữ liệu báo cáo...</span>
        </div>

        <div id="dashboard" class="hidden">
            <!-- Tối ưu 1 & 3: Đổi màu chữ và thêm 'tracking-tight' -->
            <h1 class="text-4xl font-bold tracking-tight text-center text-slate-900 mb-4">BÁO CÁO TỔNG HỢP</h1>

            <!-- CẬP NHẬT THỜI GIAN -->
            <!-- Tối ưu 1: Đổi màu chữ -->
            <div id="update-info" class="hidden text-center text-sm text-slate-600 mb-6">
                <span id="update-time">Đang tải...</span>
            </div>

            <!-- LỖI BANNER -->
            <div id="data-error-banner" class="hidden mb-6 p-5 bg-red-100 border-l-4 border-red-500 text-red-800 rounded-lg shadow-md">
                <h4 class="font-bold text-lg">Không thể tải dữ liệu!</h4>
                <p class="mt-3 font-mono text-sm bg-red-50 p-2 rounded" id="fetch-error-details"></p>
            </div>

            <!-- SẮP XẾP MỚI -->
            <div class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6">

                <!-- 1. TRẠNG THÁI PHÒNG -->
                <div class="lg:col-span-2 2xl:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <!-- Tối ưu 2: Thống nhất cấu trúc Card -->
                    <h3 class="text-xl font-semibold text-slate-900">Trạng Thái Hoạt Động</h3>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div id="trang-thai-thong-ke" class="space-y-3 mb-5"></div>
                        <div id="trang-thai-bang" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    </div>
                </div>

                <!-- 2. HÓA ĐƠN HÔM NAY -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <!-- Tối ưu 2: Thống nhất cấu trúc Card -->
                    <h3 class="text-xl font-semibold text-slate-900">Hóa Đơn Hôm Nay</h3>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div id="hd-hom-nay-bang"></div>
                    </div>
                </div>

                <!-- 3. HÓA ĐƠN HÔM QUA -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">Hóa Đơn Hôm Qua</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <!-- Tối ưu 1: Đổi màu border -->
                    <!-- SỬA ĐỔI: Thêm class 'hidden' để mục này đóng lại khi tải trang -->
                    <div id="hd-hom-qua-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                        <div id="hd-hom-qua-bang"></div>
                    </div>
                </div>

                <!-- 4. SỔ NỢ -->
                <div class="lg:col-span-2 2xl:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">Sổ Nợ</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <!-- Tối ưu 1: Đổi màu border -->
                    <!-- SỬA ĐỔI: Thêm class 'hidden' để mục này đóng lại khi tải trang -->
                    <div id="so-no-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                        <div id="so-no-bang"></div>
                    </div>
                </div>

                <!-- 5. DOANH THU 7 NGÀY -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">Doanh Thu 7 Ngày</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <!-- Tối ưu 1: Đổi màu border -->
                    <!-- SỬA ĐỔI: Thêm class 'hidden' để mục này đóng lại khi tải trang -->
                    <div id="doanh-thu-7-ngay-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                        <div id="doanh-thu-7-ngay-bang" class="space-y-1"></div>
                    </div>
                </div>

                <!-- 6. BIỂU ĐỒ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <!-- Tối ưu 2: Thống nhất cấu trúc Card -->
                    <h3 class="text-xl font-semibold text-slate-900">Doanh Thu Tháng (So Sánh)</h3>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div class="h-80"><canvas id="revenue-chart"></canvas></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // === CÀI ĐẶT ===
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxIrxlXbGlg9Y-Y-xYm4BJ9HnqaUL3K2xIps2BZ_WXCzjxShAJyMm5Y3cfMDyxR0d8/exec?v=4';
        const CACHE_KEY = 'BaoCaoCache_v3';
        const CACHE_TTL = 24 * 60 * 60 * 1000;
        let globalData = {}, chartInstance = null;

        const pageLoader = document.getElementById('page-loader');
        const dashboard = document.getElementById('dashboard');
        const errorBanner = document.getElementById('data-error-banner');
        const errorDetails = document.getElementById('fetch-error-details');
        const refreshButton = document.getElementById('refresh-button');
        const refreshToast = document.getElementById('refresh-toast');

        // === HIỂN THỊ CHỈ "BÁO CÁO TẠO LÚC" (dd/mm/yyyy hh:mm) ===
        function updateInfo(obj) {
            const a1Raw = (obj.a1 || '').replace(/^\uFEFF/, '').trim();
            if (!a1Raw) {
                document.getElementById('update-info').classList.add('hidden');
                return;
            }
            const match = a1Raw.match(/(\d{2}\/\d{2}\/\d{4}) (\d{2}:\d{2})/);
            const a1Str = match ? `${match[1]} ${match[2]}` : a1Raw;
            const el = document.getElementById('update-time');
            el.innerHTML = `<strong>Báo cáo tạo lúc:</strong> ${a1Str}`;
            document.getElementById('update-info').classList.remove('hidden');
        }

        // === TẢI DỮ LIỆU ===
        window.addEventListener('DOMContentLoaded', () => {
            const cached = getCache();
            if (cached && (Date.now() - cached.ts < CACHE_TTL)) {
                globalData = cached.data;
                renderLight();
                setTimeout(renderHeavy, 100);
                updateInfo(cached);
                fetchData(false);
            } else {
                fetchData(false);
            }
        });

        function fetchData(force = false) {
            const url = GAS_WEB_APP_URL + '&t=' + Date.now() + (force ? '&force=true' : '');
            setLoading(force);

            fetch(url)
                .then(r => r.json())
                .then(res => {
                    if (res.status !== 'success') throw new Error(res.message || 'Lỗi server');
                    updateInfo(res);

                    const cached = getCache();
                    if (!cached || cached.lastUpdated !== res.lastUpdated) {
                        globalData = res.data;
                        setCache(res.data, res.lastUpdated, res.a1);
                        renderDashboard(false);
                        if (force) showToast('Cập nhật thành công!');
                    } else if (force) {
                        showToast('Dữ liệu không thay đổi');
                    }
                    hideLoader();
                })
                .catch(err => {
                    console.error('Lỗi tải dữ liệu:', err);
                    errorDetails.textContent = err.message;
                    errorBanner.classList.remove('hidden');
                    if (getCache()) renderDashboard(true);
                    hideLoader();
                })
                .finally(() => setLoading(false));
        }

        function forceFetchData() {
            if (refreshButton.disabled) return;
            fetchData(true);
        }

        // === RENDER ===
        function renderLight() {
            if (globalData.trangThaiPhong) renderTrangThaiPhong(globalData.trangThaiPhong);
            hideLoader();
        }

        function renderHeavy() {
            if (globalData.doanhThu) renderDoanhThuChart(globalData.doanhThu);
            if (globalData.doanhThu?.ngay) renderDoanhThu7Ngay(globalData.doanhThu.ngay);
            renderTable(globalData.hdHomNay, 'hd-hom-nay-bang', 'Không có hóa đơn hôm nay');
            renderTable(globalData.hdHomQua, 'hd-hom-qua-bang', 'Không có hóa đơn hôm qua');
            renderTable(globalData.soNo, 'so-no-bang', 'Không có sổ nợ');
        }

        function renderDashboard(lazy = false) {
            renderLight();
            if (lazy) setTimeout(renderHeavy, 150);
            else renderHeavy();
        }

        // === RENDER TRẠNG THÁI PHÒNG ===
        function renderTrangThaiPhong(data) {
            const thongKeDiv = document.getElementById('trang-thai-thong-ke');
            thongKeDiv.innerHTML = `<div class="px-4 py-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 font-medium">${data.thongKe.homNay}</div>`;

            const container = document.getElementById('trang-thai-bang');
            if (!data.rooms || data.rooms.length === 0) {
                // Tối ưu 1: Đổi màu chữ
                container.innerHTML = `<p class="text-sm text-slate-500 italic">Không có dữ liệu phòng.</p>`;
                return;
            }

            let html = '';
            data.rooms.forEach(room => {
                const [tenPhong, trangThai, gioVaoSerial, ghiChu] = room;
                const colorClasses = getTrangThaiClasses(trangThai);
                const gioVaoDisplay = (trangThai.toLowerCase().includes('có khách') || trangThai.toLowerCase().includes('chưa dọn')) ? convertExcelDate(gioVaoSerial) : '';
                
                // Tối ưu 4: Thêm hiệu ứng hover cho card phòng
                html += `
                    <div class="p-3.5 rounded-lg border ${colorClasses} shadow-sm space-y-1 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 cursor-default">
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-lg">${tenPhong}</span>
                            <span class="font-semibold text-xs px-2 py-0.5 rounded-full ${colorClasses}">${trangThai}</span>
                        </div>
                        <div class="text-sm space-y-0.5">
                            <p><strong>Giờ:</strong> ${gioVaoDisplay || '---'}</p>
                            <p class="text-xs"><strong>Note:</strong> ${ghiChu || '---'}</p>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        // === RENDER BẢNG (CỘT PHỤC VỤ CHỈ HIỆN SỐ NV) ===
        function renderTable(dataBlock, elementId, emptyMessage) {
            const container = document.getElementById(elementId);
            if (!container) return;

            const card = container.closest('.bg-white');
            if (!card) return;

            if (!dataBlock || !dataBlock.rows || dataBlock.rows.length === 0) {
                if (elementId !== 'hd-hom-nay-bang') {
                    card.style.display = 'none';
                } else {
                    // Tối ưu 1: Đổi màu chữ
                    container.innerHTML = `<p class="text-sm text-slate-500 italic">${emptyMessage}</p>`;
                }
                return;
            }

            card.style.display = 'block';

            const isInvoiceTable = (elementId === 'hd-hom-nay-bang' || elementId === 'hd-hom-qua-bang');
            const isSoNoTable = (elementId === 'so-no-bang');

            let html = '<div class="flex flex-col"><div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">';
            html += '<div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">';
            // Tối ưu 1: Đổi màu border
            html += '<div class="shadow-sm ring-1 ring-black ring-opacity-5 overflow-hidden border-b border-slate-200 sm:rounded-lg">';
            html += '<table class="min-w-full divide-y divide-slate-200">';
            // Tối ưu 1: Đổi màu header bảng
            html += '<thead class="bg-slate-50"><tr>';

            // === CỘT MỚI ===
            let orderedHeaders = [];
            let orderedIndices = [];

            if (isInvoiceTable) {
                orderedHeaders = ['PHÒNG', 'THÀNH TIỀN', 'PHỤC VỤ', 'VÀO', 'RA'];
                orderedIndices = [1, 4, 5, 2, 3]; // Phòng(1), Thành tiền(4), Phục vụ(5), Vào(2), Ra(3)
            } else if (isSoNoTable) {
                orderedHeaders = ['KHÁCH HÀNG', 'THÀNH TIỀN', 'CÒN NỢ', 'NGÀY'];
                orderedIndices = [0, 2, 3, 1];
            } else {
                orderedHeaders = dataBlock.headers;
                orderedIndices = [...Array(dataBlock.headers.length).keys()];
            }

            orderedHeaders.forEach(header => {
                // Tối ưu 1: Đổi màu chữ header
                html += `<th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${header}</th>`;
            });
            // Tối ưu 1: Đổi màu border
            html += '</tr></thead><tbody class="bg-white divide-y divide-slate-200">';

            dataBlock.rows.forEach(row => {
                const detailString = isInvoiceTable ? row[row.length - 1] : '';
                const staffCount = (detailString.match(/NV/g) || []).length;
                const isClickable = isInvoiceTable && staffCount > 0;
                // Tối ưu 4: Đổi màu hover của hàng
                const trClass = isClickable ? 'cursor-pointer hover:bg-slate-50' : '';
                const trOnclick = isClickable ? `onclick="showInvoiceDetailModal(this)"` : '';

                html += `<tr class="${trClass}" ${trOnclick}>`;

                orderedIndices.forEach((idx, i) => {
                    if (isInvoiceTable && idx === 0) return;

                    let cell = row[idx] || '';
                    let displayCell = cell;

                    // === CỘT PHỤC VỤ: CHỈ HIỆN SỐ NV (IN ĐẬM) ===
                    if (isInvoiceTable && i === 2) {
                        displayCell = staffCount > 0 ? `<strong>${staffCount} NV</strong>` : '---';
                    }
                    // Định dạng giờ
                    else if (!isNaN(cell) && cell > 40000 && cell.includes('.')) {
                        displayCell = convertExcelDate(cell);
                    }
                    // Định dạng tiền
                    else if (!isNaN(cell) && parseFloat(cell) > 1000) {
                        displayCell = formatCurrency(cell);
                    }
                    // Sổ nợ: định dạng ngày
                    else if (isSoNoTable && i === 3) {
                        displayCell = formatStringDateToDM(cell);
                    }
                    // Tối ưu 1: Đổi màu chữ trong cell
                    html += `<td class="px-4 py-3 whitespace-nowrap text-sm text-slate-800">${displayCell}</td>`;
                });

                if (isInvoiceTable) {
                    html += `<td class="hidden" data-role="detail">${detailString}</td>`;
                }

                html += '</tr>';
            });

            html += '</tbody></table></div></div></div></div>';
            container.innerHTML = html;
        }

        // === BIỂU ĐỒ ===
        function renderDoanhThuChart(data) {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Tiền HĐ', 'Thực Đơn', 'Phụ Thu', 'Thực Thu'],
                    datasets: [
                        { label: data.thangTruoc.label.split('(')[0].trim(), data: data.thangTruoc.soLieu.map(Number), backgroundColor: 'rgba(251, 146, 60, 0.6)' },
                        { label: data.thangNay.label.split('(')[0].trim(), data: data.thangNay.soLieu.map(Number), backgroundColor: 'rgba(79, 70, 229, 0.6)' } // Tối ưu: Đổi màu blue sang indigo
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } } },
                    plugins: { tooltip: { callbacks: { label: c => c.dataset.label + ': ' + formatCurrency(c.parsed.y) } } }
                }
            });
        }

        // === DOANH THU 7 NGÀY ===
        function renderDoanhThu7Ngay(dataNgay) {
            const container = document.getElementById('doanh-thu-7-ngay-bang');
            const card = container.closest('.bg-white');
            if (!dataNgay || dataNgay.length === 0) { if (card) card.style.display = 'none'; return; }
            if (card) card.style.display = 'block';

            // Tối ưu 1: Đổi màu border
            let html = '<ul role="list" class="divide-y divide-slate-200">';
            let coDoanhThu = false;
            dataNgay.forEach((item, i) => {
                const thucThu = parseFloat(item.soLieu[3]), phuThu = parseFloat(item.soLieu[2]);
                if (thucThu > 0 || phuThu > 0) {
                    coDoanhThu = true;
                    // Tối ưu 4: Đổi màu hover
                    html += `<li class="py-3 px-2 -mx-2 rounded-lg hover:bg-slate-50 cursor-pointer" onclick="showRevenueDetailModal(${i})">
                        <div class="flex justify-between items-center space-x-3">
                            <div class="flex-1 min-w-0">
                                <!-- Tối ưu 1: Đổi màu chữ -->
                                <p class="text-sm font-medium text-slate-900 truncate">${item.ngay}</p>
                                <p class="text-xs text-slate-500">Phụ thu: ${formatCurrency(phuThu)}</p>
                            </div>
                            <div class="text-base font-semibold text-green-700">${formatCurrency(thucThu)}</div>
                        </div>
                    </li>`;
                }
            });
            if (!coDoanhThu && card) card.style.display = 'none';
            html += '</ul>';
            container.innerHTML = html;
        }

        // === MODAL ===
        function toggleCollapse(el) {
            const content = el.nextElementSibling;
            const icon = el.querySelector('.chevron');
            content.classList.toggle('hidden');
            icon.classList.toggle('chevron-rotated');
        }

        function openModal() {
            const modal = document.getElementById('detail-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { modal.classList.add('opacity-100'); panel.classList.add('scale-100'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('opacity-100'); panel.classList.remove('scale-100');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }

        function showInvoiceDetailModal(row) {
            const detail = row.querySelector('td[data-role="detail"]');
            if (!detail || !detail.innerText) return;
            const entries = detail.innerText.split(';').filter(Boolean);
            if (!entries.length) return;
            const firstRoom = entries[0].split('*')[0] || "Chi Tiết";
            document.getElementById('modal-title').innerText = `Chi Tiết - ${firstRoom}`;
            // Tối ưu 1: Đổi màu border
            let html = '<ul class="divide-y divide-slate-200 -mt-3">';
            entries.forEach(e => {
                const p = e.split('*');
                if (p.length < 6) return;
                // Tối ưu 1: Đổi màu chữ
                html += `<li class="py-3"><dl class="grid grid-cols-3 gap-x-4 gap-y-1 text-sm">
                    <dt class="font-medium text-slate-800">Nhân viên:</dt><dd class="text-slate-700 col-span-2">${p[1]}</dd>
                    <dt class="font-medium text-slate-800">Thời gian:</dt><dd class="text-slate-700 col-span-2">${convertExcelDate(p[2])} - ${convertExcelDate(p[3])} (${convertMinutesToHM(p[4])})</dd>
                    <dt class="font-medium text-slate-800">Thành tiền:</dt><dd class="text-blue-700 font-semibold col-span-2">${formatCurrency(p[5])}</dd>
                </dl></li>`;
            });
            document.getElementById('modal-content').innerHTML = html + '</ul>';
            openModal();
        }

        function showRevenueDetailModal(i) {
            const item = globalData.doanhThu.ngay[i];
            let html = '<dl class="space-y-3">';
            item.tieuDe.forEach((l, j) => {
                // Tối ưu 1: Đổi màu chữ
                html += `<div class="flex justify-between"><dt class="text-slate-600">${l}:</dt><dd class="font-semibold text-slate-900">${formatCurrency(item.soLieu[j])}</dd></div>`;
            });
            html += '</dl>';
            document.getElementById('modal-title').innerText = item.ngay.split('(')[0];
            document.getElementById('modal-content').innerHTML = html;
            openModal();
        }

        // === TIỆN ÍCH ===
        function getTrangThaiClasses(s) {
            s = s.toLowerCase();
            if (s.includes('trống')) return 'bg-green-50 text-green-800 border-green-200';
            if (s.includes('có khách')) return 'bg-purple-50 text-purple-800 border-purple-200';
            // Tối ưu 1: Đổi màu
            if (s.includes('chưa dọn')) return 'bg-slate-100 text-slate-700 border-slate-300';
            return 'bg-slate-50 text-slate-700 border-slate-200';
        }

        function convertExcelDate(serial) {
            if (isNaN(serial) || serial < 1) return '---';
            const date = new Date((serial - 25569) * 86400000);
            const adj = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
            return adj.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit' }).replace(',', '');
        }

        function formatStringDateToDM(str) {
            if (!str || str.length < 10) return '---';
            const p = str.split('/');
            return p.length >= 2 ? `${p[0]}/${p[1]}` : str;
        }

        function convertMinutesToHM(m) {
            if (isNaN(m) || m < 0) return '---';
            const h = Math.floor(m / 60), min = Math.round(m % 60);
            return `${h} giờ ${min} phút`;
        }

        function formatCurrency(n) {
            if (isNaN(n)) return n;
            return new Intl.NumberFormat('vi-VN').format(n);
        }

        // === CACHE & UI ===
        function getCache() {
            try {
                const c = localStorage.getItem(CACHE_KEY);
                return c ? JSON.parse(c) : null;
            } catch { return null; }
        }

        function setCache(data, lastUpdated, a1) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify({ data, lastUpdated, a1, ts: Date.now() }));
            } catch (e) { console.error('Lỗi cache:', e); }
        }

        function hideLoader() { pageLoader.style.display = 'none'; dashboard.classList.remove('hidden'); }
        function setLoading(l) { refreshButton.disabled = l; refreshButton.classList.toggle('loading', l); refreshButton.classList.toggle('disabled', l); }
        function showToast(m) { refreshToast.textContent = m; refreshToast.classList.remove('hidden'); setTimeout(() => refreshToast.classList.add('hidden'), 3000); }
    </script>
</body>
</html>
