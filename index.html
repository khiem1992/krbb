<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Online (v25 - Auto Login)</title>
    <link rel="preconnect" href="https://script.google.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #detail-modal, #security-modal { transition: opacity 0.3s ease; }
        #modal-panel, #security-panel { transition: transform 0.3s ease; }
        .chevron { transition: transform 0.2s ease-in-out; }
        .chevron-rotated { transform: rotate(180deg); }
        #refresh-button { transition: all 0.3s ease; }
        #refresh-button.disabled { opacity: 0.5; background-color: #555; cursor: not-allowed; transform: scale(0.95); }
        #refresh-icon { transition: transform 0.5s ease; }
        #refresh-button.loading #refresh-icon { transform: rotate(360deg); }
        .vip-clickable { color: #2563eb; text-decoration: underline; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .vip-clickable:hover { color: #1d4ed8; text-decoration: none; transform: scale(1.05); }
        .general-clickable { cursor: pointer; }
        .general-clickable:hover { background-color: #f9fafb; }
        @media print {
            @page { size: 58mm auto; margin: 0mm; }
            body { margin: 0; }
            body *:not(#print-invoice):not(#print-invoice *) {
    display: none !important;
}

            #print-invoice, #print-invoice * { visibility: visible; } 
            #print-invoice { position: absolute; left: 0; top: 0; width: 58mm; }
        }
        #print-invoice { width: 58mm; font-family: 'Courier New', monospace; font-size: 9px; line-height: 1.2; padding: 2mm; background: white; }
        #print-invoice .header { text-align: center; font-weight: bold; margin-bottom: 6px; font-size: 11px; }
        #print-invoice table { width: 100%; border-collapse: collapse; margin: 3px 0; }
        #print-invoice td { padding: 1px 0; font-size: 9px; }
        #print-invoice .text-right { text-align: right; }
        #print-invoice .total-line { border-top: 1px solid #000; padding-top: 2px; margin-top: 2px; }
        #print-invoice .dashed-line { border-top: 1px dashed #000; margin: 5px 0; }
        #print-invoice .footer { text-align: center; font-style: italic; margin-top: 8px; font-size: 8px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="security-modal" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[60] p-4">
        <div id="security-panel" class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 text-center">
            <div class="mb-6">
                <div class="mx-auto w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <p class="text-slate-500 mt-2">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p b√°o c√°o.</p>
            </div>
            <form onsubmit="event.preventDefault(); checkSecurity();" class="space-y-4">
                <div>
                    <input type="password" id="api-key-input" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-center text-lg" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." required autofocus autocomplete="off">
                </div>
                <div class="flex items-center justify-center mt-2">
                    <input id="remember-me" type="checkbox" checked class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="remember-me" class="ml-2 text-sm font-medium text-gray-900">Ghi nh·ªõ tr√™n m√°y n√†y</label>
                </div>
                <p id="security-error" class="text-red-500 text-sm hidden">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</p>
                <button type="submit" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md active:scale-95">
                    Truy C·∫≠p
                </button>
            </form>
        </div>
    </div>

    <div id="print-invoice" style="display: none;"></div>

    <div id="detail-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="closeModal()">
        <div id="modal-panel" class="bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center rounded-t-xl z-10">
                <h3 id="modal-title" class="text-xl font-semibold text-slate-900">Chi Ti·∫øt</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-content" class="p-6"></div>
           <div id="print-buttons" class="hidden sticky bottom-0 bg-slate-50 border-t border-slate-200 px-4 py-3 flex items-center justify-between rounded-b-xl z-10">
    <div class="flex-1"></div>

    <div class="flex-1 flex justify-center">
        <button onclick="closeModal()" class="flex items-center gap-2 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors shadow-md font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            ƒê√≥ng
        </button>
    </div>

    <div class="flex-1 flex justify-end items-center gap-1.5">
        <button onclick="printInvoicePDF()" title="In K58" class="flex items-center justify-center bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
            </svg>
        </button>
        <button onclick="downloadInvoiceJPG()" title="T·∫£i ·∫£nh JPG" class="flex items-center justify-center bg-green-600 text-white p-2 rounded hover:bg-green-700 transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
        </button>
    </div>
</div>
        </div>
    </div>

    <button id="refresh-button" onclick="forceFetchData()" class="fixed bottom-6 right-6 z-40 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 active:scale-95 hidden">
        <svg id="refresh-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.183m-4.992 0v4.992" />
        </svg>
    </button>
    <div id="refresh-toast" class="hidden fixed bottom-24 right-6 z-40 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm">ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi!</div>

    <div class="container mx-auto p-4 md:p-8 hidden" id="main-content">
        <div id="page-loader" class="flex flex-col items-center justify-center min-h-[80vh]">
            <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg text-slate-700 mt-4 animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu b√°o c√°o...</span>
        </div>

        <div id="dashboard" class="hidden">
            <h1 class="text-4xl font-bold tracking-tight text-center text-slate-900 mb-4">B√°o C√°o T·ªïng H·ª£p</h1>
            <div id="update-info" class="hidden text-center text-sm text-slate-600 mb-6"><span id="update-time">ƒêang t·∫£i...</span></div>
            <div id="data-error-banner" class="hidden mb-6 p-5 bg-red-100 border-l-4 border-red-500 text-red-800 rounded-lg shadow-md">
                <h4 class="font-bold text-lg">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu!</h4>
                <p class="mt-3 font-mono text-sm bg-red-50 p-2 rounded" id="fetch-error-details"></p>
                <button onclick="reOpenSecurity()" class="mt-3 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm font-medium">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6">
                <div class="lg:col-span-2 2xl:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-slate-900">T√¨nh Tr·∫°ng Ho·∫°t ƒê·ªông</h3>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div id="trang-thai-thong-ke" class="space-y-3 mb-5"></div>
                        <div id="trang-thai-bang" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">H√≥a ƒê∆°n G·∫ßn ƒê√¢y</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="hd-gan-day-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                        <div id="hd-gan-day-bang"></div>
                    </div>
                </div>
                <div class="lg:col-span-2 2xl:col-span-1 bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">S·ªï N·ª£</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="so-no-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                         <div id="so-no-bang"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">Doanh Thu 7 Ng√†y</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="doanh-thu-7-ngay-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                        <div id="doanh-thu-7-ngay-bang" class="space-y-1"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                     <div class="flex justify-between items-center cursor-pointer" onclick="toggleCollapse(this)">
                        <h3 class="text-xl font-semibold text-slate-900">Doanh Thu Th√°ng (So S√°nh)</h3>
                        <svg class="chevron w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="revenue-chart-content" class="mt-4 pt-4 border-t border-slate-200 hidden">
                        <div class="h-80">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz_7PFF43CENmruBnZfslWxE4XJVGH38CPYOenRw_xpZKVV54KZvS_Oi5dmDKrQadpsfQ/exec?';
        const CACHE_KEY = 'BaoCaoCache_v25_AutoLogin';
        const CACHE_TTL = 24 * 60 * 60 * 1000;
        const API_STORAGE_KEY = 'BaoCao_API_Key'; // Key ƒë·ªÉ l∆∞u m·∫≠t kh·∫©u v√†o localStorage
        
        let globalData = {};
        let vipRoomsData = {};
        let chartInstance = null;
        let currentInvoiceData = null;
        let sessionApiKey = null;

        const pageLoader = document.getElementById('page-loader');
        const dashboard = document.getElementById('dashboard');
        const errorBanner = document.getElementById('data-error-banner');
        const errorDetails = document.getElementById('fetch-error-details');
        const refreshButton = document.getElementById('refresh-button');
        const refreshToast = document.getElementById('refresh-toast');
        const printButtons = document.getElementById('print-buttons');
        const securityModal = document.getElementById('security-modal');
        const mainContent = document.getElementById('main-content');

        // *** T·ª∞ ƒê·ªòNG ƒêƒÇNG NH·∫¨P KHI M·ªû TRANG ***
        window.addEventListener('DOMContentLoaded', () => {
            // Ki·ªÉm tra xem c√≥ m·∫≠t kh·∫©u ƒë√£ l∆∞u kh√¥ng
            const savedKey = localStorage.getItem(API_STORAGE_KEY);
            if (savedKey) {
                // N·∫øu c√≥, d√πng lu√¥n v√† b·ªè qua m√†n h√¨nh ƒëƒÉng nh·∫≠p
                sessionApiKey = savedKey;
                securityModal.style.display = 'none'; // ·∫®n ngay l·∫≠p t·ª©c
                mainContent.classList.remove('hidden');
                refreshButton.classList.remove('hidden');
                initApp();
            } else {
                // N·∫øu kh√¥ng, ƒë·ª£i ng∆∞·ªùi d√πng nh·∫≠p
                // (security modal ƒë√£ hi·ªán s·∫µn do kh√¥ng c√≥ class hidden)
            }
        });

        function checkSecurity() {
            const input = document.getElementById('api-key-input');
            const rememberMe = document.getElementById('remember-me');
            const key = input.value.trim();
            
            if (key) {
                sessionApiKey = key;
                // N·∫øu ch·ªçn "Ghi nh·ªõ", l∆∞u v√†o localStorage
                if (rememberMe.checked) {
                    localStorage.setItem(API_STORAGE_KEY, key);
                }
                
                securityModal.classList.add('opacity-0');
                setTimeout(() => {
                    securityModal.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    refreshButton.classList.remove('hidden');
                    initApp();
                }, 300);
            }
        }

        function reOpenSecurity() {
             localStorage.removeItem(API_STORAGE_KEY); // X√≥a m·∫≠t kh·∫©u c≈© n·∫øu sai
             errorBanner.classList.add('hidden');
             mainContent.classList.add('hidden');
             refreshButton.classList.add('hidden');
             securityModal.style.display = ''; // Reset display style
             securityModal.classList.remove('hidden');
             securityModal.classList.remove('opacity-0');
             document.getElementById('api-key-input').value = '';
             document.getElementById('api-key-input').focus();
        }

        function updateInfo(obj) {
            const a1Raw = (obj.a1 || '').replace(/^\uFEFF/, '').trim();
            if (!a1Raw) { document.getElementById('update-info').classList.add('hidden'); return; }
            const match = a1Raw.match(/(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})\s*(\d{1,2}:\d{2}(:\d{2})?)?/);
            document.getElementById('update-time').innerHTML = `<strong>B√°o c√°o t·∫°o l√∫c:</strong> ${match ? match[0] : a1Raw}`;
            document.getElementById('update-info').classList.remove('hidden');
        }

        function initApp() {
            const cached = getCache();
            if (cached && (Date.now() - cached.ts < CACHE_TTL)) {
                globalData = cached.data;
                vipRoomsData = cached.vipRooms || {}; 
                renderLight();
                setTimeout(renderHeavy, 100);
                updateInfo(cached);
                fetchData(false);
            } else { fetchData(false); }
        }

        function fetchData(force = false) {
            if (!sessionApiKey) return;
            const url = `${GAS_WEB_APP_URL}key=${encodeURIComponent(sessionApiKey)}&t=${Date.now()}${force ? '&force=true' : ''}`;
            setLoading(force);
            fetch(url).then(r => r.json()).then(res => {
                if (res.status === 'error') {
                    if (res.message && res.message.includes('Truy c·∫≠p b·ªã t·ª´ ch·ªëi')) {
                        localStorage.removeItem(API_STORAGE_KEY); // T·ª± ƒë·ªông x√≥a m·∫≠t kh·∫©u sai
                        throw new Error('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ thay ƒë·ªïi! Vui l√≤ng nh·∫≠p l·∫°i.');
                    }
                    throw new Error(res.message || 'L·ªói server');
                }
                updateInfo(res);
                vipRoomsData = res.vipRooms || {};
                const cached = getCache();
                if (!cached || cached.lastUpdated !== res.lastUpdated) {
                    globalData = res.data;
                    setCache(res.data, res.lastUpdated, res.a1, res.vipRooms);
                    renderDashboard(false);
                    if (force) showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                } else if (force) { showToast('D·ªØ li·ªáu kh√¥ng thay ƒë·ªïi'); }
                hideLoader();
            }).catch(err => {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err);
                errorDetails.textContent = err.message;
                errorBanner.classList.remove('hidden');
                if (err.message.includes('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng')) {
                     dashboard.classList.add('hidden');
                     pageLoader.style.display = 'none';
                } else {
                    if (getCache()) renderDashboard(true);
                    hideLoader();
                }
            }).finally(() => setLoading(false));
        }

        function forceFetchData() {
            if (refreshButton.disabled) return;
            fetchData(true);
        }

        function renderLight() {
            if (globalData.trangThaiPhong) renderTrangThaiPhong(globalData.trangThaiPhong);
            hideLoader();
        }

        function renderHeavy() {
            if (globalData.doanhThu) renderDoanhThuChart(globalData.doanhThu);
            if (globalData.doanhThu?.ngay) renderDoanhThu7Ngay(globalData.doanhThu.ngay);
            renderTable(globalData.hdGanDay, 'hd-gan-day-bang', 'Kh√¥ng c√≥ h√≥a ƒë∆°n g·∫ßn ƒë√¢y');
            renderTable(globalData.soNo, 'so-no-bang', 'Kh√¥ng c√≥ s·ªï n·ª£');
        }

        function renderDashboard(lazy = false) {
            renderLight();
            if (lazy) setTimeout(renderHeavy, 150);
            else renderHeavy();
        }

        function renderTrangThaiPhong(data) {
            const thongKeDiv = document.getElementById('trang-thai-thong-ke');
            thongKeDiv.innerHTML = `<div class="px-4 py-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 font-medium">${data.thongKe.homNay || '---'}</div>`;
            const container = document.getElementById('trang-thai-bang');
            if (!data.rooms || data.rooms.length === 0) {
                container.innerHTML = `<p class="text-sm text-slate-500 italic">Kh√¥ng c√≥ d·ªØ li·ªáu ph√≤ng.</p>`;
                return;
            }
            let html = '';
            data.rooms.forEach(room => {
                const [tenPhong, trangThai, gioVaoSerial, ghiChu] = room;
                const colorClasses = getTrangThaiClasses(trangThai || '');
                const gioVaoDisplay = (trangThai && (trangThai.toLowerCase().includes('c√≥ kh√°ch') || trangThai.toLowerCase().includes('ch∆∞a d·ªçn'))) ? convertExcelDate(gioVaoSerial) : '';
                let onclickAttr = '';
                if (/VIP\s*1/i.test(tenPhong)) onclickAttr = `onclick="showVIPDetail('VIP 1')" style="cursor:pointer"`;
                else if (/VIP\s*2/i.test(tenPhong)) onclickAttr = `onclick="showVIPDetail('VIP 2')" style="cursor:pointer"`;
                else if (/VIP\s*3/i.test(tenPhong)) onclickAttr = `onclick="showVIPDetail('VIP 3')" style="cursor:pointer"`;
                html += `
                    <div class="p-3.5 rounded-lg border ${colorClasses} shadow-sm space-y-1 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200" ${onclickAttr}>
                        <div class="flex justify-between items-start"><span class="font-bold text-lg">${tenPhong || '---'}</span><span class="font-semibold text-xs px-2 py-0.5 rounded-full ${colorClasses}">${trangThai || '---'}</span></div>
                        <div class="text-sm space-y-0.5"><p><strong>Gi·ªù:</strong> ${gioVaoDisplay || '---'}</p><p class="text-xs"><strong>Note:</strong> ${ghiChu || '---'}</p></div>
                    </div>`;
            });
            container.innerHTML = html;
        }

            // === H√ÄM ƒê√É S·ª¨A: Nh√≥m Hƒê theo ng√†y th√†nh c√°c th·∫ª ri√™ng bi·ªát ===
        function renderTable(dataBlock, elementId, emptyMessage) {
            const container = document.getElementById(elementId);
            if (!container) return;
            const card = container.closest('.bg-white');
            if (!card) return;

            if (!dataBlock || !dataBlock.rows || dataBlock.rows.length === 0) {
                if (elementId !== 'hd-gan-day-bang') card.style.display = 'none';
                else container.innerHTML = `<p class="text-sm text-slate-500 italic">${emptyMessage}</p>`;
                return;
            }

            card.style.display = 'block';
            const isInvoiceTable = (elementId === 'hd-gan-day-bang');
            const isSoNoTable = (elementId === 'so-no-bang');
            
            // Bi·∫øn HTML t·ªïng
            let html = '';

            // X√°c ƒë·ªãnh Headers v√† Indices cho c·∫£ hai lo·∫°i b·∫£ng
            let orderedHeaders = [];
            let orderedIndices = [];
            if (isInvoiceTable) {
                orderedHeaders = ['PH√íNG', 'TH√ÄNH TI·ªÄN', 'TH·ª∞C ƒê∆†N', 'PH·ª§C V·ª§', 'V√ÄO', 'RA'];
                orderedIndices = [1, 4, 5, 6, 2, 3]; // [Ph√≤ng, Ti·ªÅn, Menu, PV, V√†o, Ra]
            } else if (isSoNoTable) {
                orderedHeaders = ['KH√ÅCH H√ÄNG', 'TH√ÄNH TI·ªÄN', 'C√íN N·ª¢', 'NG√ÄY'];
                orderedIndices = [0, 1, 2, 3];
            } else {
                orderedHeaders = dataBlock.headers;
                orderedIndices = [...Array(dataBlock.headers.length).keys()];
            }

            // === L LOGIC M·ªöI: N·∫æU L√Ä B·∫¢NG H√ìA ƒê∆†N ===
            if (isInvoiceTable) {
                // 1. Nh√≥m h√≥a ƒë∆°n theo ng√†y
                const grouped = {};
                dataBlock.rows.forEach(row => {
                    // Nh√≥m theo Gi·ªù Ra (row[3])
                    const checkoutTimeString = formatDateTime(row[3], true) || '';
                    
                    if (!checkoutTimeString) {
                        const dateKey = 'Kh√¥ng r√µ ng√†y';
                        if (!grouped[dateKey]) grouped[dateKey] = [];
                        grouped[dateKey].push(row);
                        return; // B·ªè qua n·∫øu kh√¥ng c√≥ th·ªùi gian ra
                    }

                    // *** B·∫ÆT ƒê·∫¶U LOGIC M·ªöI: T√çNH TO√ÅN CA L√ÄM VI·ªÜC (07:00 - 06:59) ***
                    
                    // 1. Chuy·ªÉn chu·ªói "DD/MM/YYYY HH:MM" th√†nh ƒë·ªëi t∆∞·ª£ng Date
                    const checkoutDateObj = parseDMYHM(checkoutTimeString); 

                    if (!checkoutDateObj) {
                        // N·∫øu kh√¥ng th·ªÉ parse, d√πng t·∫°m ng√†y g·ªëc
                        const dateKey = checkoutTimeString.split(' ')[0] || 'L·ªói ƒë·ªãnh d·∫°ng ng√†y';
                        if (!grouped[dateKey]) grouped[dateKey] = [];
                        grouped[dateKey].push(row);
                        return; 
                    }

                    // 2. T·∫°o m·ªôt b·∫£n sao ƒë·ªÉ t√≠nh to√°n ng√†y nh√≥m
                    let groupingDateObj = new Date(checkoutDateObj);
                    
                    // 3. Ki·ªÉm tra gi·ªù: N·∫øu gi·ªù ra < 7 gi·ªù s√°ng (t·ª©c 00:00 - 06:59)
                    if (checkoutDateObj.getHours() < 7) {
                        // T√≠nh l√† h√≥a ƒë∆°n c·ªßa ng√†y h√¥m tr∆∞·ªõc
                        groupingDateObj.setDate(groupingDateObj.getDate() - 1);
                    }
                    
                    // 4. L·∫•y ng√†y ƒë√£ ƒëi·ªÅu ch·ªânh (DD/MM/YYYY) ƒë·ªÉ l√†m kh√≥a nh√≥m
                    const dateKey = formatDateToDMY(groupingDateObj); 
                    // *** K·∫æT TH√öC LOGIC M·ªöI ***

                    if (!grouped[dateKey]) grouped[dateKey] = [];
                    grouped[dateKey].push(row);
                });

                // 2. B·∫Øt ƒë·∫ßu render HTML cho c√°c nh√≥m
                html = '<div class="space-y-6">'; // Container cho t·∫•t c·∫£ c√°c th·∫ª ng√†y

                Object.keys(grouped).forEach(date => {
                    // Th·∫ª cho m·ªói ng√†y
                    html += `
                    <div class="bg-slate-50 rounded-xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-all">
                        <div class="bg-indigo-200 text-indigo-900 text-center py-2 font-semibold text-sm tracking-wide">
                            üìÖ ${date}
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-100">
                                    <tr>
                                        ${orderedHeaders.map(h => `
                                            <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${h}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-100">
                    `;

                    // Render c√°c h√†ng cho ng√†y ƒë√≥
                    grouped[date].forEach(row => {
                        html += `<tr class="hover:bg-slate-50 cursor-pointer" onclick="showCombinedDetailModal(this, event)">`;
                        orderedIndices.forEach((idx, i) => {
                            if (idx === 0) return; // B·ªè qua c·ªôt Hƒê (index 0)
                            
                            let cell = row[idx] || '';
                            let displayCell = cell;
                            let tdClass = 'px-4 py-3 whitespace-nowrap text-sm text-slate-800';
                            let tdOnclick = ''; // Click ch√≠nh ƒë√£ n·∫±m tr√™n <tr>

                            if (i === 0) { // C·ªôt ph√≤ng (idx 1)
                                const tenPhong = row[1];
                                const tenKH = row[7]; // L·∫•y T√™n KH
                                displayCell = tenKH ? `${tenPhong} - <span class="font-semibold text-indigo-700">${tenKH}</span>` : tenPhong;
                            } 
                            else if (i === 2) { // Th·ª±c ƒë∆°n (idx 5)
                                const menuItems = (cell && cell.includes('*')) ? cell.split(';').filter(Boolean).length : 0;
                                displayCell = menuItems > 0 
                                    ? `<span class="vip-clickable">${menuItems} m√≥n</span>` 
                                    : '---';
                                // NgƒÉn click <tr> n·∫øu click v√†o link n√†y
                                if (menuItems > 0) tdOnclick = `onclick="showMenuDetailModal(this, event); event.stopPropagation();"`; 
                            } 
                            else if (i === 3) { // Ph·ª•c v·ª• (idx 6)
                                const staffCount = (cell && cell.includes('*')) ? cell.split(';').filter(Boolean).length : 0;
                                displayCell = staffCount > 0 
                                    ? `<strong class="vip-clickable">${staffCount} NV</strong>` 
                                    : '---';
                                // NgƒÉn click <tr> n·∫øu click v√†o link n√†y
                                if (staffCount > 0) tdOnclick = `onclick="showStaffDetailModal(this, event); event.stopPropagation();"`;
                            } 
                            else if (!isNaN(cell) && cell > 40000 && cell.toString().includes('.')) {
                                displayCell = convertExcelDate(cell);
                            } 
                            else if (!isNaN(cell) && parseFloat(cell) > 1000) {
                                displayCell = formatCurrency(cell);
                            }

                            html += `<td class="${tdClass}" ${tdOnclick}>${displayCell}</td>`;
                        });
                        
                        // Th√™m d·ªØ li·ªáu ·∫©n
                        html += `
                            <td class="hidden" data-role="detail">${row[6]}</td>
                            <td class="hidden" data-role="menu">${row[5]}</td>
                            <td class="hidden" data-role="raw-data">${JSON.stringify(row)}</td>
                        `;
                        html += `</tr>`;
                    });

                    // ƒê√≥ng th·∫ª table v√† div
                    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                });
                html += '</div>'; // ƒê√≥ng space-y-6

            // === LOGIC C≈®: N·∫æU L√Ä B·∫¢NG S·ªî N·ª¢ (GI·ªÆ NGUY√äN) ===
            } else if (isSoNoTable) {
                html = '<div class="flex flex-col"><div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">';
                html += '<div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">';
                html += '<div class="shadow-sm ring-1 ring-black ring-opacity-5 overflow-hidden border-b border-slate-200 sm:rounded-lg">';
                html += '<table class="min-w-full divide-y divide-slate-200">';
                html += '<thead class="bg-slate-50"><tr>';
                orderedHeaders.forEach(header => {
                    html += `<th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${header}</th>`;
                });
                html += '</tr></thead><tbody class="bg-white divide-y divide-slate-200">';

                dataBlock.rows.forEach(row => {
                    html += `<tr class="hover:bg-slate-50">`; // S·ªï n·ª£ kh√¥ng c·∫ßn click
                    orderedIndices.forEach((idx, i) => {
                        let cell = row[idx] || '';
                        let displayCell = cell;
                        let tdClass = 'px-4 py-3 whitespace-nowrap text-sm text-slate-800';

                        if (i === 3) { 
                            displayCell = formatStringDateToDM(cell);
                        } else if (i === 1 || i === 2) { 
                            displayCell = `<span class="font-medium">${formatCurrency(cell)}</span>`;
                        }
                        html += `<td class="${tdClass}">${displayCell}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div></div></div></div>'; // ƒê√≥ng table wrappers
            
            } 
            // (B·∫°n c√≥ th·ªÉ th√™m 'else' ·ªü ƒë√¢y n·∫øu c√≥ lo·∫°i b·∫£ng th·ª© 3)

            // Ghi HTML v√†o container
            container.innerHTML = html;
        }

        function renderDoanhThuChart(data) {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ti·ªÅn Hƒê', 'Th·ª±c ƒê∆°n', 'Ph·ª• Thu', 'Th·ª±c Thu'],
                    datasets: [
                        { label: (data.thangTruoc.label || 'Th√°ng tr∆∞·ªõc').split('(')[0].trim(), data: (data.thangTruoc.soLieu || []).map(Number), backgroundColor: 'rgba(251, 146, 60, 0.6)' },
                        { label: (data.thangNay.label || 'Th√°ng n√†y').split('(')[0].trim(), data: (data.thangNay.soLieu || []).map(Number), backgroundColor: 'rgba(79, 70, 229, 0.6)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } } },
                    plugins: { tooltip: { callbacks: { label: c => c.dataset.label + ': ' + formatCurrency(c.parsed.y) } } }
                }
            });
        }

        function renderDoanhThu7Ngay(dataNgay) {
            const container = document.getElementById('doanh-thu-7-ngay-bang');
            const card = container.closest('.bg-white');
            if (!dataNgay || dataNgay.length === 0) { if (card) card.style.display = 'none'; return; }
            if (card) card.style.display = 'block';
            let html = '<ul role="list" class="divide-y divide-slate-200">';
            let coDoanhThu = false;
            dataNgay.forEach((item, i) => {
                const thucThu = parseFloat(item.soLieu[3]), phuThu = parseFloat(item.soLieu[2]);
                if (thucThu > 0 || phuThu > 0) {
                    coDoanhThu = true;
                    html += `<li class="py-3 px-2 -mx-2 rounded-lg hover:bg-slate-50 cursor-pointer" onclick="showRevenueDetailModal(${i})">
                        <div class="flex justify-between items-center space-x-3"><div class="flex-1 min-w-0"><p class="text-sm font-medium text-slate-900 truncate">${item.ngay}</p><p class="text-xs text-slate-500">Ph·ª• thu: ${formatCurrency(phuThu)}</p></div><div class="text-base font-semibold text-green-700">${formatCurrency(thucThu)}</div></div></li>`;
                }
            });
            if (!coDoanhThu && card) card.style.display = 'none';
            html += '</ul>';
            container.innerHTML = html;
        }

        function toggleCollapse(el) {
            const content = el.nextElementSibling;
            const icon = el.querySelector('.chevron');
            content.classList.toggle('hidden');
            icon.classList.toggle('chevron-rotated');
        }

        function openModal() {
            const modal = document.getElementById('detail-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { modal.classList.add('opacity-100'); panel.classList.add('scale-100'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('opacity-100'); panel.classList.remove('scale-100');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
            printButtons.classList.add('hidden');
            currentInvoiceData = null;
        }

        function showRevenueDetailModal(i) {
            const item = globalData.doanhThu.ngay[i];
            let html = '<dl class="space-y-3">';
            item.tieuDe.forEach((l, j) => {
                html += `<div class="flex justify-between"><dt class="text-slate-600">${l}:</dt><dd class="font-semibold text-slate-900">${formatCurrency(item.soLieu[j])}</dd></div>`;
            });
            html += '</dl>';
            document.getElementById('modal-title').innerText = item.ngay.split('(')[0];
            document.getElementById('modal-content').innerHTML = html;
            printButtons.classList.add('hidden');
            openModal();
        }

        function showVIPDetail(vipName) {
            const normalizedName = vipName.replace(/\s+/g, ' ').trim();
            let vipData = vipRoomsData[normalizedName];
            if (!vipData) {
                const variants = [normalizedName.replace(/\s/g, ''), normalizedName.toUpperCase(), normalizedName.toLowerCase()];
                for (const variant of variants) { vipData = vipRoomsData[variant]; if (vipData) break; }
            }
            if (!vipData) { alert(`Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt cho ${vipName}`); return; }

            currentInvoiceData = {
                type: 'vip',
                phong: vipName,
                gioVao: vipData.gioVao,
                gioRa: vipData.gioRa,
                thucDon: vipData.thucDon,
                nhanVien: vipData.nhanVien,
                tongThucDon: vipData.tongThucDon,
                tongNhanVien: vipData.tongNhanVien,
                tongCong: (vipData.tongThucDon || 0) + (vipData.tongNhanVien || 0),
                soNhanVien: vipData.soNhanVien
            };
            document.getElementById('modal-title').innerText = `Chi Ti·∫øt - ${vipName}`;
            let html = '<div class="space-y-6">';
            html += `<div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4 border border-indigo-200"><h4 class="font-semibold text-indigo-900 mb-3 text-lg flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Th√¥ng Tin Chung</h4><div class="grid grid-cols-2 gap-3 text-sm"><div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">Gi·ªù v√†o</span><strong class="text-indigo-700">${formatDateTime(vipData.gioVao, true)}</strong></div><div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">Gi·ªù ra</span><strong class="text-indigo-700">${formatDateTime(vipData.gioRa, true)}</strong></div><div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">Ch√≠nh s√°ch</span><strong class="text-green-600">${vipData.chinhSach || '---'}</strong></div><div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">S·ªë NV</span><strong class="text-blue-600">${vipData.soNhanVien} ng∆∞·ªùi</strong></div></div></div>`;
            if (vipData.thucDon && vipData.thucDon.length > 0) {
                html += `<div><h4 class="font-semibold text-slate-900 mb-3 flex items-center"><svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Th·ª±c ƒê∆°n (${vipData.thucDon.length} m√≥n)</h4><div class="bg-white border border-slate-200 rounded-lg overflow-hidden"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-orange-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase">M√≥n</th><th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase">SL</th><th class="px-4 py-2 text-right text-xs font-medium text-slate-700 uppercase">ƒê∆°n gi√°</th><th class="px-4 py-2 text-right text-xs font-medium text-slate-700 uppercase">Th√†nh ti·ªÅn</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                vipData.thucDon.forEach(mon => { html += `<tr class="hover:bg-orange-50 transition-colors"><td class="px-4 py-2 text-sm text-slate-800">${mon.ten}</td><td class="px-4 py-2 text-sm text-center font-medium text-slate-700">${mon.soLuong}</td><td class="px-4 py-2 text-sm text-right text-slate-600">${formatCurrency(mon.donGia)}</td><td class="px-4 py-2 text-sm text-right font-semibold text-slate-900">${formatCurrency(mon.thanhTien)}</td></tr>`; });
                html += `</tbody><tfoot class="bg-orange-50 border-t-2 border-orange-200"><tr><td colspan="3" class="px-4 py-3 text-sm font-bold text-slate-700 text-right">T·ªïng th·ª±c ƒë∆°n:</td><td class="px-4 py-3 text-base font-bold text-orange-600 text-right">${formatCurrency(vipData.tongThucDon)}</td></tr></tfoot></table></div></div>`;
            } else { html += `<div class="text-sm text-slate-500 italic bg-slate-50 rounded-lg p-4 text-center">Ch∆∞a c√≥ th·ª±c ƒë∆°n</div>`; }
            
            if (vipData.nhanVien && vipData.nhanVien.length > 0) {
                html += `<div><h4 class="font-semibold text-slate-900 mb-3 flex items-center"><svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Nh√¢n Vi√™n Ph·ª•c V·ª• (${vipData.soNhanVien})</h4><div class="space-y-3">`;
                vipData.nhanVien.forEach((nv, idx) => { html += `<div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 hover:shadow-md transition-all"><div class="flex justify-between items-start mb-2"><div><span class="font-semibold text-slate-900 text-base">${idx + 1}. ${nv.ten}</span><p class="text-xs text-slate-600 mt-1"><strong>Th·ªùi gian:</strong> ${formatDateTime(nv.gioVao)} ‚Üí ${formatDateTime(nv.gioRa)}</p><p class="text-xs text-slate-600"><strong>T·ªïng:</strong> ${convertMinutesToHM(nv.tongPhut)}</p></div><span class="font-bold text-lg text-blue-700">${formatCurrency(nv.thanhTien)}</span></div></div>`; });
                html += `</div><div class="mt-4 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg p-4 border-2 border-blue-300"><div class="flex justify-between items-center"><span class="font-bold text-slate-800 text-lg">T·ªïng ti·ªÅn nh√¢n vi√™n:</span><span class="font-bold text-blue-700 text-2xl">${formatCurrency(vipData.tongNhanVien)}</span></div></div></div>`;
            } else { html += `<div class="text-sm text-slate-500 italic bg-slate-50 rounded-lg p-4 text-center">Ch∆∞a c√≥ nh√¢n vi√™n ph·ª•c v·ª•</div>`; }
            
            const tongCong = currentInvoiceData.tongCong;
            html += `<div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg p-5 border-2 border-green-400"><div class="flex justify-between items-center"><span class="font-bold text-slate-900 text-xl">T·ªîNG C·ªòNG:</span><span class="font-bold text-green-700 text-3xl">${formatCurrency(tongCong)}</span></div><div class="mt-2 text-sm text-slate-600 flex justify-between"><span>Th·ª±c ƒë∆°n: ${formatCurrency(vipData.tongThucDon)}</span><span>Nh√¢n vi√™n: ${formatCurrency(vipData.tongNhanVien)}</span></div></div>`;
            html += '</div>';
            document.getElementById('modal-content').innerHTML = html;
            printButtons.classList.remove('hidden');
            openModal();
        }

        function parseStaffJS(raw) {
            if (!raw || raw === '') return [];
            try {
                return raw.toString().split(';').filter(x => x.trim() !== '').map(item => {
                    const parts = item.split('*');
                    if (parts.length < 6) return null; 
                    return {
                        phong: parts[0] || '',
                        ten: parts[1] || '',
                        gioVao: parseFloat(parts[2]) || 0,
                        gioRa: parseFloat(parts[3]) || 0,
                        tongPhut: parseFloat(parts[4]) || 0,
                        thanhTien: parseFloat(parts[5]) || 0
                    };
                }).filter(x => x !== null);
            } catch (e) { console.error('L·ªói parse nh√¢n vi√™n:', e); return []; }
        }

        function parseThucDonJS(raw) {
            if (!raw || raw === '') return [];
            try {
                return raw.toString().split(';').filter(x => x.trim() !== '').map(item => {
                    const parts = item.split('*');
                    if (parts.length < 3) return null;
                    const soLuong = parseFloat(parts[1]) || 0;
                    const donGia = parseFloat(parts[2]) || 0;
                    return {
                        ten: parts[0] || '',
                        soLuong: Math.max(0, soLuong),
                        donGia: Math.max(0, donGia),
                        thanhTien: Math.max(0, soLuong) * Math.max(0, donGia)
                    };
                }).filter(x => x !== null);
            } catch (e) { console.error('L·ªói parse th·ª±c ƒë∆°n:', e); return []; }
        }

        function showCombinedDetailModal(tdElement, event) {
            event.stopPropagation();
            const row = tdElement.closest('tr');
            const rawDataString = row.querySelector('td[data-role="raw-data"]').innerText;
            if (!rawDataString) return;
            
            const rowData = JSON.parse(rawDataString);
            const menuData = parseThucDonJS(rowData[5]);
            const staffData = parseStaffJS(rowData[6]);
            
            const tongThucDon = menuData.reduce((sum, m) => sum + m.thanhTien, 0);
            const tongNhanVien = staffData.reduce((sum, nv) => sum + nv.thanhTien, 0);
            const thanhTienHD = parseFloat(rowData[4]) || 0;

            // TH√äM T√äN KH V√ÄO D·ªÆ LI·ªÜU MODAL
            currentInvoiceData = {
                type: 'regular',
                soHD: rowData[0],
                phong: rowData[1],
                gioVao: rowData[2],
                gioRa: rowData[3],
                thanhTienHD: thanhTienHD,
                thucDon: menuData,
                nhanVien: staffData,
                tongThucDon: tongThucDon,
                tongNhanVien: tongNhanVien,
                tongCong: thanhTienHD,
                soNhanVien: staffData.length,
                tenKH: rowData[7] || '' // L·∫•y T√™n KH t·ª´ index 7
            };
            document.getElementById('modal-title').innerText = `Chi Ti·∫øt H√≥a ƒê∆°n - ${rowData[1]}`;
            
            let html = '<div class="space-y-6">';
            
            // S·ª¨A L·∫†I LAYOUT ƒê·ªÇ TH√äM T√äN KH
            html += `
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4 border border-indigo-200">
                    <h4 class="font-semibold text-indigo-900 mb-3 text-lg flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         Th√¥ng Tin H√≥a ƒê∆°n
                    </h4>
                    <div class="grid grid-cols-3 gap-3 text-sm">
                        <div class="bg-white rounded p-2"><span class="text-slate-600 text-xs 
 block">S·ªë Hƒê</span><strong class="text-indigo-700">${rowData[0]}</strong></div>
                        <div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">Ph√≤ng</span><strong class="text-indigo-700">${rowData[1]}</strong></div>
                        
                        <div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">T√™n KH</span><strong class="text-indigo-700">${currentInvoiceData.tenKH || '---'}</strong></div>

                        <div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">Gi·ªù v√†o</span><strong class="text-indigo-700">${formatDateTime(rowData[2], true)}</strong></div>
                        <div class="bg-white rounded p-2"><span class="text-slate-600 text-xs block">Gi·ªù ra</span><strong class="text-indigo-700">${formatDateTime(rowData[3], true)}</strong></div>
 
                         <div class="bg-white rounded p-2 col-span-3"><span class="text-slate-600 text-xs block">Th√†nh ti·ªÅn Hƒê</span><strong class="text-2xl text-green-600">${formatCurrency(rowData[4])}</strong></div>
                    </div>
                </div>`;
            
            // Ph·∫ßn c√≤n l·∫°i c·ªßa h√†m (Th·ª±c ƒë∆°n, Nh√¢n vi√™n) gi·ªØ nguy√™n
            if (menuData.length > 0) {
                html += `<div><h4 class="font-semibold text-slate-900 mb-3 flex items-center"><svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Th·ª±c ƒê∆°n (${menuData.length} m√≥n)</h4><div class="bg-white border border-slate-200 rounded-lg overflow-hidden"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-orange-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase">M√≥n</th><th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase">SL</th><th class="px-4 py-2 text-right text-xs font-medium text-slate-700 uppercase">Th√†nh ti·ªÅn</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                menuData.forEach(mon => {
                    html += `<tr class="hover:bg-orange-50 transition-colors"><td class="px-4 py-2 text-sm text-slate-800">${mon.ten}</td><td class="px-4 py-2 text-sm text-center font-medium text-slate-700">${mon.soLuong}</td><td class="px-4 py-2 text-sm text-right font-semibold text-slate-900">${formatCurrency(mon.thanhTien)}</td></tr>`; 
                });
                html += `</tbody><tfoot class="bg-orange-50 border-t-2 border-orange-200"><tr><td colspan="2" class="px-4 py-3 text-sm font-bold text-slate-700 text-right">T·ªïng th·ª±c ƒë∆°n:</td><td class="px-4 py-3 text-base font-bold text-orange-600 text-right">${formatCurrency(tongThucDon)}</td></tr></tfoot></table></div></div>`;
            } else {
                html += `<div class="text-sm text-slate-500 italic bg-slate-50 rounded-lg p-4 text-center">Kh√¥ng c√≥ th·ª±c ƒë∆°n</div>`;
            }

            if (staffData.length > 0) {
                html += `<div><h4 class="font-semibold text-slate-900 mb-3 flex items-center"><svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Nh√¢n Vi√™n Ph·ª•c V·ª• (${staffData.length})</h4><div class="space-y-3">`;
                staffData.forEach((nv, idx) => {
                    html += `<div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4"><div class="flex justify-between items-start mb-2"><div><span class="font-semibold text-slate-900 text-base">${idx + 1}. ${nv.ten}</span><p class="text-xs text-slate-600 mt-1"><strong>Th·ªùi gian:</strong> ${convertExcelDate(nv.gioVao)} ‚Üí ${convertExcelDate(nv.gioRa)} (${convertMinutesToHM(nv.tongPhut)})</p></div><span class="font-bold text-lg text-blue-700">${formatCurrency(nv.thanhTien)}</span></div></div>`;
                });
                html += `</div><div class="mt-4 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg p-4 border-2 border-blue-300"><div class="flex justify-between items-center"><span class="font-bold text-slate-800 text-lg">T·ªïng ti·ªÅn nh√¢n vi√™n:</span><span class="font-bold text-blue-700 text-2xl">${formatCurrency(tongNhanVien)}</span></div></div></div>`;
            } else {
                html += `<div class="text-sm text-slate-500 italic bg-slate-50 rounded-lg p-4 text-center">Kh√¥ng c√≥ nh√¢n vi√™n ph·ª•c v·ª•</div>`;
            }

            html += '</div>';
            document.getElementById('modal-content').innerHTML = html;
            printButtons.classList.remove('hidden');
            openModal();
        }

        function showStaffDetailModal(tdElement, event) {
            event.stopPropagation();
            const row = tdElement.closest('tr');
            const detailString = row.querySelector('td[data-role="detail"]').innerText;
            
            const entries = parseStaffJS(detailString);
            if (!entries.length) {
                document.getElementById('modal-title').innerText = 'Chi Ti·∫øt Ph·ª•c V·ª•';
                document.getElementById('modal-content').innerHTML = `<div class="text-sm text-slate-500 italic bg-slate-50 rounded-lg p-4 text-center">Kh√¥ng c√≥ nh√¢n vi√™n ph·ª•c v·ª•</div>`;
                printButtons.classList.add('hidden');
                openModal();
                return;
            }
            
            const firstRoom = entries[0].phong || "Chi Ti·∫øt";
            document.getElementById('modal-title').innerText = `Chi Ti·∫øt - ${firstRoom}`;
            
            let html = '<ul class="divide-y divide-slate-200 -mt-3">';
            entries.forEach(nv => {
                html += `<li class="py-3"><dl class="grid grid-cols-3 gap-x-4 gap-y-1 text-sm">
                    <dt class="font-medium text-slate-800">Nh√¢n vi√™n:</dt><dd class="text-slate-700 col-span-2">${nv.ten}</dd>
                    <dt class="font-medium text-slate-800">Th·ªùi gian:</dt><dd class="text-slate-700 col-span-2">${convertExcelDate(nv.gioVao)} - ${convertExcelDate(nv.gioRa)} (${convertMinutesToHM(nv.tongPhut)})</dd>
                    <dt class="font-medium text-slate-800">Th√†nh ti·ªÅn:</dt><dd class="text-blue-700 font-semibold col-span-2">${formatCurrency(nv.thanhTien)}</dd>
                </dl></li>`;
            });
            document.getElementById('modal-content').innerHTML = html + '</ul>';
            printButtons.classList.add('hidden');
            openModal();
        }

        function showMenuDetailModal(tdElement, event) {
            event.stopPropagation();
            const row = tdElement.closest('tr');
            const menuString = row.querySelector('td[data-role="menu"]').innerText;
            
            const menuData = parseThucDonJS(menuString);
            if (menuData.length === 0) {
                document.getElementById('modal-title').innerText = 'Chi Ti·∫øt Th·ª±c ƒê∆°n';
                document.getElementById('modal-content').innerHTML = `<div class="text-sm text-slate-500 italic bg-slate-50 rounded-lg p-4 text-center">Kh√¥ng c√≥ th·ª±c ƒë∆°n</div>`;
                printButtons.classList.add('hidden');
                openModal();
                return;
            }

            const phong = JSON.parse(row.querySelector('td[data-role="raw-data"]').innerText)[1];
            document.getElementById('modal-title').innerText = `Th·ª±c ƒê∆°n - ${phong}`;

            let html = '<div class="space-y-4">';
            let tongThucDon = 0;
            html += `<div class="bg-white border border-slate-200 rounded-lg overflow-hidden"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-orange-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase">M√≥n</th><th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase">SL</th><th class="px-4 py-2 text-right text-xs font-medium text-slate-700 uppercase">ƒê∆°n gi√°</th><th class="px-4 py-2 text-right text-xs font-medium text-slate-700 uppercase">Th√†nh ti·ªÅn</th></tr></thead><tbody class="divide-y divide-slate-100">`;
            menuData.forEach(mon => {
                tongThucDon += mon.thanhTien;
                html += `<tr class="hover:bg-orange-50 transition-colors"><td class="px-4 py-2 text-sm text-slate-800">${mon.ten}</td><td class="px-4 py-2 text-sm text-center font-medium text-slate-700">${mon.soLuong}</td><td class="px-4 py-2 text-sm text-right text-slate-600">${formatCurrency(mon.donGia)}</td><td class="px-4 py-2 text-sm text-right font-semibold text-slate-900">${formatCurrency(mon.thanhTien)}</td></tr>`;
            });
            html += `</tbody><tfoot class="bg-orange-50 border-t-2 border-orange-200"><tr><td colspan="3" class="px-4 py-3 text-sm font-bold text-slate-700 text-right">T·ªïng th·ª±c ƒë∆°n:</td><td class="px-4 py-3 text-base font-bold text-orange-600 text-right">${formatCurrency(tongThucDon)}</td></tr></tfoot></table></div>`;
            html += '</div>';
            document.getElementById('modal-content').innerHTML = html;
            printButtons.classList.add('hidden');
            openModal();
        }

        // === H√ÄM T·∫†O H√ìA ƒê∆†N IN K58 ===
        function generateInvoiceHTML() {
            if (!currentInvoiceData) return '';
            const now = new Date();
            const dateStr = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear().toString().slice(-2)}`;
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            let tienGio = 0;
            // *** S·ª≠a logic: Kh√¥ng hi·ªÉn th·ªã ti·ªÅn gi·ªù n·∫øu l√† VIP ***
            let showTienGio = true; 
            
            if (currentInvoiceData.type === 'regular') {
                 tienGio = currentInvoiceData.tongCong - currentInvoiceData.tongThucDon - currentInvoiceData.tongNhanVien;
                 // ƒê·∫£m b·∫£o ti·ªÅn gi·ªù kh√¥ng √¢m nh·ªè do sai s·ªë
                 if (tienGio < 0 && Math.abs(tienGio) < 100) tienGio = 0;
            } else {
                 tienGio = 0;
                 showTienGio = false; // VIP kh√¥ng hi·ªÉn th·ªã d√≤ng ti·ªÅn gi·ªù = 0
            }

            let html = `<div class="header">PHI·∫æU PH·ª§C V·ª§</div>
                        <div style="margin-bottom: 6px;"><strong>Ph√≤ng: ${currentInvoiceData.phong}</strong></div>`;
            
            if (currentInvoiceData.nhanVien && currentInvoiceData.nhanVien.length > 0) {
                html += `
                <table style="font-size: 9px;">
                    <thead><tr><td style="width: 25%;"><strong>NV</strong></td><td style="width: 25%;"><strong>V√†o</strong></td><td style="width: 25%;"><strong>Ra</strong></td><td style="width: 25%; text-align: right;"><strong>T.Ti·ªÅn</strong></td></tr></thead>
                    <tbody>`;
                currentInvoiceData.nhanVien.forEach(nv => {
                    html += `<tr><td>${nv.ten}</td><td>${convertExcelDate(nv.gioVao)}</td><td>${convertExcelDate(nv.gioRa)}</td><td style="text-align: right;">${formatCurrency(nv.thanhTien)}</td></tr>`;
                });
                html += `</tbody></table>
                <div style="text-align: right; margin-top: 5px; font-size: 9px;"><strong>T·ªîNG PH·ª§ THU: ${formatCurrency(currentInvoiceData.tongNhanVien)}</strong><div style="font-size: 10px; line-height: 1; margin: 3px 0;">----------------------------------</div></div>`;
            }
            
            html += `<div class="header">PHI·∫æU THANH TO√ÅN</div>
                     <div style="margin: 4px 0;"><strong>Ph√≤ng: ${currentInvoiceData.phong}</strong></div>`;
            if (currentInvoiceData.soHD) html += `<div style="margin: 2px 0; font-size: 9px;">Hƒê: ${currentInvoiceData.soHD}</div>`;
            
            html += `<div style="margin: 2px 0; font-size: 9px;">V√†o: ${formatDateTime(currentInvoiceData.gioVao, true)}</div>
                     <div style="margin: 2px 0; font-size: 9px;">Ra: ${formatDateTime(currentInvoiceData.gioRa, true)}</div>`;
            
            // *** X√ìA D√íNG HI·ªÇN TH·ªä TH·ªúI GIAN THEO Y√äU C·∫¶U ***
            
            if (currentInvoiceData.thucDon && currentInvoiceData.thucDon.length > 0) {
                html += `<table style="margin-top: 5px;"><thead><tr><td style="width: 50%;"><strong>T√™n h√†ng</strong></td><td style="width: 25%; text-align: center;"><strong>SL</strong></td><td style="width: 25%; text-align: right;"><strong>T.Ti·ªÅn</strong></td></tr></thead><tbody>`;
                currentInvoiceData.thucDon.forEach(mon => {
                    html += `<tr><td>${mon.ten}</td><td style="text-align: center;">${mon.soLuong}</td><td style="text-align: right;">${formatCurrency(mon.thanhTien)}</td></tr>`;
                });
                html += `</tbody></table><div style="font-size: 10px; line-height: 1; margin: 5px 0;">----------------------------------</div>`;
            }
            
            // T·ªîNG K·∫æT
            html += `<div style="margin-top: 5px; font-size: 9px;">
                        <div style="display: flex; justify-content: space-between; margin: 2px 0;"><span>Th·ª±c ƒë∆°n:</span><strong>${formatCurrency(currentInvoiceData.tongThucDon)}</strong></div>`;
            
            // Ch·ªâ hi·ªÉn th·ªã d√≤ng ti·ªÅn gi·ªù n·∫øu l√† Hƒê th∆∞·ªùng (showTienGio = true)
            if (showTienGio) {
                html += `<div style="display: flex; justify-content: space-between; margin: 2px 0;"><span>Ti·ªÅn gi·ªù:</span><strong>${formatCurrency(tienGio)}</strong></div>`;
            }
            
            html += `<div style="display: flex; justify-content: space-between; margin: 2px 0;"><span>Ph·ª• thu:</span><strong>${formatCurrency(currentInvoiceData.tongNhanVien)}</strong></div>
                     </div>
                     <div style="font-size: 10px; line-height: 1; margin: 5px 0;">----------------------------------</div>
                     <div style="margin-top: 4px; font-size: 11px;"><div style="display: flex; justify-content: space-between;"><strong>Th√†nh ti·ªÅn:</strong><strong style="font-size: 13px;">${formatCurrency(currentInvoiceData.tongCong)}</strong></div></div>
                     <div style="font-size: 10px; line-height: 1; margin: 5px 0;">***********************************</div>
                     <div class="footer">In l√∫c: ${dateStr} ${timeStr}<br>C·∫£m ∆°n qu√Ω kh√°ch. H·∫πn g·∫∑p l·∫°i!</div>`;
            return html;
        }

        function printInvoicePDF() {
            if (!currentInvoiceData) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n ƒë·ªÉ in!'); return; }
            const printDiv = document.getElementById('print-invoice');
            printDiv.innerHTML = generateInvoiceHTML();
            printDiv.style.display = 'block';
            setTimeout(() => { window.print(); printDiv.style.display = 'none'; }, 100);
        }

        async function downloadInvoiceJPG() {
            if (!currentInvoiceData) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n ƒë·ªÉ t·∫£i!'); return; }
            const printDiv = document.getElementById('print-invoice');
            printDiv.innerHTML = generateInvoiceHTML();
            printDiv.style.display = 'block';
            try {
                const canvas = await html2canvas(printDiv, { scale: 3, backgroundColor: '#ffffff', width: 220, windowWidth: 220 });
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `HoaDon_${currentInvoiceData.phong.replace(/\s+/g, '_')}_${new Date().getTime()}.jpg`;
                    link.click();
                    URL.revokeObjectURL(url);
                    printDiv.style.display = 'none';
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('L·ªói khi t·∫°o ·∫£nh:', error);
                alert('Kh√¥ng th·ªÉ t·∫°o ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!');
                printDiv.style.display = 'none';
            }
        }

        function getTrangThaiClasses(s) {
            s = s.toLowerCase();
            if (s.includes('tr·ªëng')) return 'bg-green-50 text-green-800 border-green-400';
            if (s.includes('c√≥ kh√°ch')) return 'bg-purple-100 text-purple-800 border-purple-400';
            if (s.includes('ch∆∞a d·ªçn')) return 'bg-slate-100 text-slate-700 border-slate-400';
            return 'bg-slate-50 text-slate-700 border-slate-200';
        }

        function formatDateTime(value, fullDate = false) {
            if (typeof value === 'string' && value.trim() !== '') {
                if (value.match(/\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/)) return value;
                if (value.match(/^\d{1,2}:\d{2}$/)) return value;
            }
            return convertExcelDate(value, fullDate);
        }

function parseDMYHM(str) {
            if (!str) return null;
            // T√°ch chu·ªói theo ƒë·ªãnh d·∫°ng "DD/MM/YYYY HH:MM:SS"
            const parts = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
            if (!parts) return null;
            // parts[1] = DD, parts[2] = MM, parts[3] = YYYY, parts[4] = HH, parts[5] = MM
            // Ch√∫ √Ω: Th√°ng trong JavaScript Date l√† 0-11, n√™n c·∫ßn - 1
            return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5]);
        }

        function formatDateToDMY(dateObj) {
            if (!dateObj) return 'Kh√¥ng r√µ ng√†y';
            const d = String(dateObj.getDate()).padStart(2, '0');
            const m = String(dateObj.getMonth() + 1).padStart(2, '0'); // +1 v√¨ th√°ng l√† 0-11
            const y = dateObj.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function convertExcelDate(serial, fullDate = false) {
            if (!serial || serial === '' || serial === 0) return '---';
            if (typeof serial === 'string') serial = parseFloat(serial);
            if (isNaN(serial) || serial < 0) return '---';
            const date = new Date((serial - 25569) * 86400000);
            const adj = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
            if (fullDate) {
                return `${String(adj.getDate()).padStart(2,'0')}/${String(adj.getMonth()+1).padStart(2,'0')}/${adj.getFullYear()} ${String(adj.getHours()).padStart(2,'0')}:${String(adj.getMinutes()).padStart(2,'0')}`;
            } else {
                return `${String(adj.getHours()).padStart(2,'0')}:${String(adj.getMinutes()).padStart(2,'0')}`;
            }
        }

        function formatStringDateToDM(str) {
            if (!str || str.length < 10) return '---';
            const p = str.split('/');
            return p.length >= 2 ? `${p[0]}/${p[1]}` : str;
        }

        function convertMinutesToHM(m) {
            if (isNaN(m) || m < 0) return '---';
            const h = Math.floor(m / 60), min = Math.round(m % 60);
            return `${h} gi·ªù ${min} ph√∫t`;
        }

        function formatCurrency(n) {
            if (isNaN(n)) return n;
            return new Intl.NumberFormat('vi-VN').format(n);
        }

        function getCache() {
            try { return JSON.parse(localStorage.getItem(CACHE_KEY)); } catch { return null; }
        }

        function setCache(data, lastUpdated, a1, vipRooms) {
            try { localStorage.setItem(CACHE_KEY, JSON.stringify({ data, lastUpdated, a1, vipRooms, ts: Date.now() })); } catch (e) { console.error('L·ªói cache:', e); }
        }

        function hideLoader() { pageLoader.style.display = 'none'; dashboard.classList.remove('hidden'); }
        function setLoading(l) { refreshButton.disabled = l; refreshButton.classList.toggle('loading', l); refreshButton.classList.toggle('disabled', l); }
        function showToast(m) { refreshToast.textContent = m; refreshToast.classList.remove('hidden'); setTimeout(() => refreshToast.classList.add('hidden'), 3000); }
    </script>
</body>
</html>
